<!-- discussion/discussion-post/discussion-post.component.html -->
<div class="container mt-4" *ngIf="!isLoading">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- Back Button -->
      <div class="mb-3">
        <button class="btn btn-outline-secondary" (click)="goBack()">
          <i class="fa fa-arrow-left me-2"></i>Back to Discussions
        </button>
      </div>

      <!-- Discussion Post -->
      <div class="card border-primary shadow mb-4" *ngIf="discussionPost">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h2 class="mb-2">{{ discussionPost.title }}</h2>
              <div class="d-flex align-items-center text-light opacity-75">
                <div class="me-3" *ngIf="discussionPost.author">
                  <img *ngIf="discussionPost.author.photoUrl"
                       [src]="discussionPost.author.photoUrl"
                       class="rounded-circle me-2" width="24" height="24" alt="Author">
                  <span>{{ discussionPost.author.displayName }}</span>
                </div>
                <div class="me-3">
                  <i class="fa fa-clock me-1"></i>
                  {{ getRelativeTime(discussionPost.createdAt) }}
                </div>
                <div class="me-3">
                  <i class="fa fa-comments me-1"></i>
                  {{ discussionPost.commentsCount }} comments
                </div>
                <div>
                  <span class="badge"
                        [class.bg-success]="discussionPost.privacyType === 'Public'"
                        [class.bg-warning]="discussionPost.privacyType === 'Private'">
                    <i class="fa"
                       [class.fa-globe]="discussionPost.privacyType === 'Public'"
                       [class.fa-lock]="discussionPost.privacyType === 'Private'"
                       class="me-1"></i>
                    {{ discussionPost.privacyType }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="dropdown" *ngIf="canEditPost()">
              <button class="btn btn-outline-light btn-sm dropdown-toggle"
                      type="button" data-bs-toggle="dropdown">
                <i class="fa fa-ellipsis-v"></i>
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" (click)="editPost()">
                  <i class="fa fa-edit me-2"></i>Edit Post
                </a></li>
                <li><a class="dropdown-item text-danger" (click)="deletePost()">
                  <i class="fa fa-trash me-2"></i>Delete Post
                </a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="card-body">
          <!-- Description -->
          <div class="mb-4" *ngIf="discussionPost.description">
            <p class="lead">{{ discussionPost.description }}</p>
          </div>

          <!-- Tags -->
          <div class="mb-4" *ngIf="discussionPost.tags && discussionPost.tags.length > 0">
            <div class="d-flex flex-wrap gap-2">
              <span *ngFor="let tag of discussionPost.tags"
                    class="badge bg-secondary cursor-pointer"
                    (click)="navigateToTag(tag)">
                #{{ tag }}
              </span>
            </div>
          </div>

          <!-- Voting and Sharing -->
          <div class="d-flex justify-content-between align-items-center border-top pt-3">
            <div class="d-flex align-items-center gap-3">
              <div class="d-flex align-items-center">
                <button class="btn btn-outline-success btn-sm"
                        [disabled]="isVoting"
                        (click)="voteOnPost('up')">
                  <span *ngIf="isVoting" class="spinner-border spinner-border-sm me-1"></span>
                  <i class="fa fa-thumbs-up me-1" *ngIf="!isVoting"></i>{{ discussionPost.upVotes }}
                </button>
                <button class="btn btn-outline-danger btn-sm ms-2"
                        [disabled]="isVoting"
                        (click)="voteOnPost('down')">
                  <span *ngIf="isVoting" class="spinner-border spinner-border-sm me-1"></span>
                  <i class="fa fa-thumbs-down me-1" *ngIf="!isVoting"></i>{{ discussionPost.downVotes }}
                </button>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" (click)="sharePost()">
                <i class="fa fa-share me-1"></i>Share
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Comment Form -->
      <div class="card border-secondary mb-4" *ngIf="canReplyToComment()">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">
            <i class="fa fa-comment me-2"></i>Add Comment
          </h5>
        </div>
        <div class="card-body">
          <form [formGroup]="commentForm" (ngSubmit)="submitComment()">
            <div class="mb-3">
              <textarea class="form-control"
                        [class.is-invalid]="hasFormFieldError(commentForm, 'content')"
                        formControlName="content"
                        rows="4"
                        placeholder="Share your thoughts..."></textarea>
              <div class="invalid-feedback" *ngIf="hasFormFieldError(commentForm, 'content')">
                {{ getFormFieldError(commentForm, 'content') }}
              </div>
            </div>
            <div class="text-end">
              <button type="submit"
                      class="btn btn-primary"
                      [disabled]="commentForm.invalid || isSubmittingComment">
                <span *ngIf="isSubmittingComment" class="spinner-border spinner-border-sm me-2"></span>
                <i class="fa fa-paper-plane me-2" *ngIf="!isSubmittingComment"></i>
                Post Comment
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Comments Section -->
      <div class="card border-info" *ngIf="discussionPost && discussionPost.comments.length > 0">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="fa fa-comments me-2"></i>
            Comments ({{ discussionPost.commentsCount }})
          </h5>
        </div>
        <div class="card-body p-0">
          <!-- Comment Item Template -->
          <ng-container *ngTemplateOutlet="commentTemplate; context: {
            comments: discussionPost.comments,
            level: 0
          }"></ng-container>
        </div>
      </div>

      <!-- No Comments Message -->
      <div class="card border-light text-center py-5"
           *ngIf="discussionPost && discussionPost.comments.length === 0">
        <div class="card-body">
          <i class="fa fa-comments fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No comments yet</h5>
          <p class="text-muted">Be the first to share your thoughts!</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6 text-center">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted">Loading discussion post...</p>
    </div>
  </div>
</div>

<!-- Comment Template -->
<ng-template #commentTemplate let-comments="comments" let-level="level">
  <div *ngFor="let comment of comments"
       class="comment-item border-bottom"
       [style.margin-left.px]="level * 30">

    <div class="p-3">
      <!-- Comment Header -->
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="d-flex align-items-center">
          <img *ngIf="comment.author?.photoUrl"
               [src]="comment.author.photoUrl"
               class="rounded-circle me-2" width="32" height="32" alt="Author">
          <div>
            <div class="fw-bold">{{ comment.author?.displayName || 'Anonymous' }}</div>
            <div class="text-muted small">{{ getRelativeTime(comment.createdAt) }}</div>
          </div>
        </div>

        <!-- Comment Actions -->
        <div class="dropdown" *ngIf="canDeleteComment(comment)">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                  type="button" data-bs-toggle="dropdown">
            <i class="fa fa-ellipsis-v"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item text-danger" (click)="deleteComment(comment.id)">
              <i class="fa fa-trash me-2"></i>Delete
            </a></li>
          </ul>
        </div>
      </div>

      <!-- Comment Content -->
      <div class="mb-3">
        <p class="mb-0">{{ comment.content }}</p>
      </div>

      <!-- Comment Actions -->
      <div class="d-flex align-items-center gap-3">
        <button class="btn btn-sm btn-link text-muted p-0"
                (click)="showReplyFormFor(comment.id)"
                *ngIf="canReplyToComment() && !isReplyFormVisible(comment.id)">
          <i class="fa fa-reply me-1"></i>Reply
        </button>

        <button class="btn btn-sm btn-link text-muted p-0"
                (click)="toggleCommentExpansion(comment.id)"
                *ngIf="hasReplies(comment)">
          <i class="fa"
             [class.fa-chevron-down]="!isCommentExpanded(comment.id)"
             [class.fa-chevron-up]="isCommentExpanded(comment.id)"
             class="me-1"></i>
          {{ getReplyCount(comment) }}
          {{ getReplyCount(comment) === 1 ? 'reply' : 'replies' }}
        </button>
      </div>

      <!-- Reply Form -->
      <div *ngIf="isReplyFormVisible(comment.id)" class="mt-3">
        <form [formGroup]="replyForm" (ngSubmit)="submitReply(comment.id)">
          <div class="mb-2">
            <textarea class="form-control form-control-sm"
                      [class.is-invalid]="hasFormFieldError(replyForm, 'content')"
                      formControlName="content"
                      rows="3"
                      placeholder="Write a reply..."></textarea>
            <div class="invalid-feedback" *ngIf="hasFormFieldError(replyForm, 'content')">
              {{ getFormFieldError(replyForm, 'content') }}
            </div>
          </div>
          <div class="d-flex gap-2">
            <button type="submit"
                    class="btn btn-sm btn-primary"
                    [disabled]="replyForm.invalid || isSubmittingReplyFor(comment.id)">
              <span *ngIf="isSubmittingReplyFor(comment.id)" class="spinner-border spinner-border-sm me-1"></span>
              <i class="fa fa-paper-plane me-1" *ngIf="!isSubmittingReplyFor(comment.id)"></i>Reply
            </button>
            <button type="button"
                    class="btn btn-sm btn-outline-secondary"
                    (click)="hideReplyForm(comment.id)">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Nested Replies -->
    <div *ngIf="hasReplies(comment) && isCommentExpanded(comment.id)">
      <ng-container *ngTemplateOutlet="commentTemplate; context: {
        comments: comment.childComments,
        level: level + 1
      }"></ng-container>
    </div>
  </div>
</ng-template>

<style>
.cursor-pointer {
  cursor: pointer;
}

.comment-item:last-child {
  border-bottom: none !important;
}

.comment-item:hover {
  background-color: rgba(0, 0, 0, 0.02);
}
</style>
